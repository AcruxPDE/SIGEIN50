-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [IDP].[F_OBTIENE_CI]
(
	-- Add the parameters for the function here
	@PIN_ID_CUESTIONARIO AS INT,
	@PIN_NO_OPCION AS INT -- 1 ES DE APTITUD MENTAL 1, 2 ES DE APTITUD MENTAL 2
)
RETURNS INT
AS
BEGIN
	
	-- VARIABLES PARA CALCULAR EL COEFICIENTE INTELECTUAL
	DECLARE @V_NO_CI AS INT
	DECLARE @PIN_TOTAL AS INT

	IF @PIN_NO_OPCION = 1 BEGIN

	SELECT @PIN_TOTAL = CAST(NO_VALOR AS INT) FROM IDP.K_RESULTADO WHERE ID_CUESTIONARIO = @PIN_ID_CUESTIONARIO AND ID_VARIABLE = 1145
	
	-- OBTENEMOS LAS 3 PRIMERAS VARIABLES QUE SE USAN PARA EL COEFICIENTE INTELECTUAL
	SET @V_NO_CI = CASE 
						WHEN @PIN_TOTAL BETWEEN 67 AND 69 THEN 80
						WHEN @PIN_TOTAL BETWEEN 70 AND 71 THEN 81
						WHEN @PIN_TOTAL BETWEEN 72 AND 74 THEN 82
						WHEN @PIN_TOTAL BETWEEN 75 AND 76 THEN 83
						WHEN @PIN_TOTAL BETWEEN 77 AND 80 THEN 84
						WHEN @PIN_TOTAL BETWEEN 81 AND 82 THEN 85
						WHEN @PIN_TOTAL BETWEEN 83 AND 85 THEN 86
						WHEN @PIN_TOTAL = 86 THEN 87
						WHEN @PIN_TOTAL BETWEEN 87 AND 90 THEN 88
						WHEN @PIN_TOTAL BETWEEN 91 AND 93 THEN 89
						WHEN @PIN_TOTAL BETWEEN 94 AND 96 THEN 90
						WHEN @PIN_TOTAL BETWEEN 97 AND 99 THEN 91
						WHEN @PIN_TOTAL BETWEEN 100 AND 102 THEN 92
						WHEN @PIN_TOTAL BETWEEN 103 AND 104 THEN 93
						WHEN @PIN_TOTAL BETWEEN 105 AND 106 THEN 94
						WHEN @PIN_TOTAL BETWEEN 107 AND 109 THEN 95
						WHEN @PIN_TOTAL BETWEEN 110 AND 113 THEN 96
						WHEN @PIN_TOTAL BETWEEN 114 AND 116 THEN 97
						WHEN @PIN_TOTAL BETWEEN 117 AND 119 THEN 98
						WHEN @PIN_TOTAL BETWEEN 120 AND 122 THEN 99
						WHEN @PIN_TOTAL = 123 THEN 99
						WHEN @PIN_TOTAL BETWEEN 124 AND 125 THEN 100
						WHEN @PIN_TOTAL BETWEEN 126 AND 129 THEN 101
						WHEN @PIN_TOTAL BETWEEN 130 AND 133 THEN 102
						WHEN @PIN_TOTAL BETWEEN 134 AND 137 THEN 103
						WHEN @PIN_TOTAL BETWEEN 138 AND 141 THEN 104
						WHEN @PIN_TOTAL BETWEEN 142 AND 145 THEN 105
						WHEN @PIN_TOTAL BETWEEN 146 AND 149 THEN 106
						WHEN @PIN_TOTAL BETWEEN 150 AND 153 THEN 107
						WHEN @PIN_TOTAL BETWEEN 154 AND 157 THEN 108
						WHEN @PIN_TOTAL BETWEEN 158 AND 159 THEN 109
						WHEN @PIN_TOTAL BETWEEN 160 AND 162 THEN 110
						WHEN @PIN_TOTAL BETWEEN 163 AND 166 THEN 111
						WHEN @PIN_TOTAL = 167 THEN 112
						WHEN @PIN_TOTAL BETWEEN 168 AND 170 THEN 113
						WHEN @PIN_TOTAL BETWEEN 171 AND 173 THEN 114
						WHEN @PIN_TOTAL BETWEEN 174 AND 175 THEN 115
						WHEN @PIN_TOTAL BETWEEN 176 AND 177 THEN 116
						WHEN @PIN_TOTAL = 178 THEN 117
						WHEN @PIN_TOTAL BETWEEN 179 AND 180 THEN 117
						WHEN @PIN_TOTAL BETWEEN 181 AND 183 THEN 118
						WHEN @PIN_TOTAL BETWEEN 184 AND 185 THEN 119
						WHEN @PIN_TOTAL BETWEEN 186 AND 188 THEN 120
						WHEN @PIN_TOTAL BETWEEN 189 AND 191 THEN 121
						WHEN @PIN_TOTAL BETWEEN 192 AND 194 THEN 122
						WHEN @PIN_TOTAL BETWEEN 195 AND 197 THEN 123
						WHEN @PIN_TOTAL BETWEEN 198 AND 200 THEN 124
						WHEN @PIN_TOTAL BETWEEN 201 AND 202 THEN 125
						WHEN @PIN_TOTAL BETWEEN 203 AND 205 THEN 126
						WHEN @PIN_TOTAL BETWEEN 206 AND 207 THEN 127
						ELSE 0
					END
	END

	IF @PIN_NO_OPCION = 2 BEGIN
		
		SELECT @PIN_TOTAL = SUM(NO_VALOR) FROM IDP.K_RESULTADO WHERE ID_CUESTIONARIO = @PIN_ID_CUESTIONARIO AND CL_TIPO_RESULTADO = 2 GROUP BY ID_CUESTIONARIO

		SET @V_NO_CI = CASE
						 WHEN @PIN_TOTAL BETWEEN 0 AND 16 THEN 65
						 WHEN @PIN_TOTAL BETWEEN 17 AND 18 THEN 66
						 WHEN @PIN_TOTAL BETWEEN 19 AND 20 THEN 68
						 WHEN @PIN_TOTAL BETWEEN 21 AND 22 THEN 70
						 WHEN @PIN_TOTAL BETWEEN 23 AND 24 THEN 72
						 WHEN @PIN_TOTAL BETWEEN 25 AND 26 THEN 74
						 WHEN @PIN_TOTAL BETWEEN 27 AND 28 THEN 76
						 WHEN @PIN_TOTAL BETWEEN 29 AND 30 THEN 78
						 WHEN @PIN_TOTAL = 31 THEN 80
						 WHEN @PIN_TOTAL BETWEEN 32 AND 33 THEN 82
						 WHEN @PIN_TOTAL BETWEEN 34 AND 35 THEN 84
						 WHEN @PIN_TOTAL BETWEEN 36 AND 37 THEN 86
						 WHEN @PIN_TOTAL BETWEEN 38 AND 39 THEN 88
						 WHEN @PIN_TOTAL BETWEEN 40 AND 41 THEN 90
						 WHEN @PIN_TOTAL BETWEEN 42 AND 43 THEN 92
						 WHEN @PIN_TOTAL BETWEEN 44 AND 45 THEN 94
						 WHEN @PIN_TOTAL BETWEEN 46 AND 47 THEN 96
						 WHEN @PIN_TOTAL = 48 THEN 98
						 WHEN @PIN_TOTAL BETWEEN 49 AND 50 THEN 100
						 WHEN @PIN_TOTAL BETWEEN 51 AND 52 THEN 102
						 WHEN @PIN_TOTAL BETWEEN 53 AND 54 THEN 104
						 WHEN @PIN_TOTAL BETWEEN 55 AND 56 THEN 106
						 WHEN @PIN_TOTAL BETWEEN 57 AND 58 THEN 108
						 WHEN @PIN_TOTAL BETWEEN 59 AND 60 THEN 110
						 WHEN @PIN_TOTAL BETWEEN 61 AND 62 THEN 112
						 WHEN @PIN_TOTAL BETWEEN 63 AND 64 THEN 114
						 WHEN @PIN_TOTAL = 65 THEN 116
						 WHEN @PIN_TOTAL BETWEEN 66 AND 67 THEN 118
						 WHEN @PIN_TOTAL BETWEEN 68 AND 69 THEN 120
						 WHEN @PIN_TOTAL BETWEEN 70 AND 71 THEN 122
						 WHEN @PIN_TOTAL = 72 THEN 124
						 WHEN @PIN_TOTAL = 73 THEN 125
						 WHEN @PIN_TOTAL = 74 THEN 126
						 WHEN @PIN_TOTAL = 75 THEN 127
						 ELSE 0 END 

	END

	-- Return the result of the function
	RETURN @V_NO_CI

END
